#!/usr/bin/env node

'use strict';

var UppTalk = require('..');
var debug = false;
var DEBUG = function(msg) {
  if (debug)
    console.log(msg);
};

if (process.argv.length < 3) {
  console.log('Usage: upptalk (-v) (--apikey=YOURAPIKEY) (username:password) method (payload)');
  process.exit(1);
}

var username;
var password;
var method;
var payload;
var apikey;
for (var i = 2; i < process.argv.length; i++) {
  var arg = process.argv[i];
  //verbose
  if (arg === '-v') {
    debug = true;
    continue;
  }
  //apikey
  if (arg.indexOf('--apikey=') === 0) {
    apikey = arg.split('--apikey=')[1];
    continue;
  }
  //credentials
  if (!username && arg.indexOf(':') > -1) {
    var creds = arg.split(':');
    username = creds[0];
    password = creds[1];
    continue;
  }
  //method
  if (arg.indexOf('=') === -1) {
    method = arg;
    continue;
  }

  if (!payload)
    payload = {};

  //fields
  var keyvalue = arg.split('=');
  payload[keyvalue[0]] = keyvalue[1];
}

var client;
if (apikey)
  client = new UppTalk({apikey: apikey});
else
  client = new UppTalk();

DEBUG('OPENING');
client.open(function() {
  DEBUG('OPEN');
  if (username && password) {
    DEBUG('AUTHENTICATING');
    this.send('authenticate', {username: username, password: password}, function(err) {
      if (err) {
        console.log('Authentication failed');
        process.exit(1);
      }
      DEBUG('AUTHENTICATED');
      call(method, payload);
    });
  }
  else {
    call(method, payload);
  }
});
client.once('close', function() {
  DEBUG('CLOSE');
  process.exit(1);
});


var done = function(err, res) {
  DEBUG('RESPONSE');
  if (err) {
    console.log('ERROR:', err);
  }
  else {
    console.log('SUCESS:', res);
  }
  DEBUG('CLOSING');
  client.close();
};

var call = function(method, payload) {
  DEBUG('SENDING');
  if (payload) {
    client.send(method, payload, done);
  }
  else {
    client.send(method, done);
  }
  DEBUG('SENT');
};